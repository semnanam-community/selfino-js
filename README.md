๐ฝ๏ธ ุฑุจุงุช ูุฏุฑุช ุฎุฑุฏ ู ูุฑูุด ฺุชูู ุณูู ุฏุงูุดุฌู

ุงู ูพุฑูฺู ฺฉ ุฑุจุงุช ุชูฺฏุฑุงู Serverless ู ุจุณุงุฑ ุจูููโุณุงุฒโุดุฏู ุงุณุช ฺฉู ุจู ููุธูุฑ ุชุณูู ูุฑุขูุฏ ูุงฺฏุฐุงุฑุ ุฎุฑุฏ ู ูุฑูุด ฺุชูู/ูุนุฏูโูุง ุบุฐุง ุณูู ุฏุงูุดุฌูุงู ุทุฑุงุญ ุดุฏู ุงุณุช. ุงู ุฑุจุงุช ุจุง ุจูุฑูโฺฏุฑ ุงุฒ ุฒุฑุณุงุฎุช ุงุจุฑ ูุฏุฑุชููุฏ Cloudflare Workers ู ุฏุชุงุจุณ ุชูุฒุนโุดุฏู Cloudflare D1 (ุจุฑ ูพุงู SQLite) ุชูุณุนู ุงูุชู ู ูุงุฒ ุจู ุณุฑูุฑูุง ุณูุช (VPS) ูุฏุงุฑุฏ.


๐ ูุนูุงุฑ ู ููุงูุฑโูุง

    ูุญุท ุงุฌุฑุง (Runtime): Cloudflare Workers (V8 Isolate) - ููุงุณโูพุฐุฑ ุจโููุงุช ู ุฒูุงู ุงุฌุฑุง ุจุณุงุฑ ูพุงู (Zero Cold Start).

    ูพุงฺฏุงู ุฏุงุฏู: Cloudflare D1 (Serverless SQLite) - ุณุฑุนุ ฺฉูพุงุฑฺู ุจุง ูุฑฺฉุฑุฒ ู ฺฉุงููุงู ูุฏุฑุชโุดุฏู.

    ุฑุงุจุท ุจุฑูุงููโููุณ: Telegram Bot API (ุจุง ูพุดุชุจุงู ฺฉุงูู ุงุฒ ูุงุจูุชโูุง ูุณุฎู 9.4 ุจู ุจุงูุง).

    ูุฏุฑุช ูพุณโุฒููู: ุจูุฑูโฺฏุฑ ุงุฒ ctx.waitUntil() ุฌูุช ุงูุฌุงู ุนููุงุชโูุง ุณูฺฏู (ูุงููุฏ Broadcast) ุจุฏูู ูุณุฏูุฏ ฺฉุฑุฏู ูพุงุณุฎฺฏู ุจู ุฏุฑุฎูุงุณุชโูุง HTTP.

โจ ูุงุจูุชโูุง ู ูฺฺฏโูุง ูู
๐งโ๐ ูฺฺฏโูุง ุณูุช ฺฉุงุฑุจุฑ (Client-Side)

    ุฑุงุจุท ฺฉุงุฑุจุฑ ูุฏุฑู: ุงุณุชูุงุฏู ุงุฒ ุฏฺฉููโูุง ุดุดูโุง ุฑูฺฏ (style attribute) ู ุงููุฌโูุง ูพุฑููู ุณูุงุฑุด (icon_custom_emoji_id) ุจุฑ ุงุณุงุณ ุขุฎุฑู ุขูพุฏุชโูุง Telegram Bot API.

    ุฌุฑุงู ฺฏุงูโุจูโฺฏุงู (Step-by-step Flow): ุซุจุช ุฏุฑุฎูุงุณุชโูุง (ุฎุฑุฏ/ูุฑูุดุ ุงูุชุฎุงุจ ุณููุ ูุนุฏู ู ุฑูุฒ) ุจู ุตูุฑุช ุชุนุงูู ุจุง ุฐุฎุฑู State ฺฉุงุฑุจุฑ.

    ูุญุฏูุฏุชโูุง ููุดููุฏ:

        ุฌููฺฏุฑ ุงุฒ ุงุฑุณุงู ุงุณูพู ุจุง ูุญุฏูุฏุช ุซุจุช ุญุฏุงฺฉุซุฑ ณ ุฏุฑุฎูุงุณุช ุฏุฑ ุฑูุฒ ุจุฑุง ูุฑ ฺฉุงุฑุจุฑ.

        ฺฉุดโุณุงุฒ ุฏุฑุฎูุงุณุชโูุง (Duplicate Cache) ุจุง ูุดโฺฏุฐุงุฑ (SHA-256) ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุซุจุช ุฏุฑุฎูุงุณุช ุชฺฉุฑุงุฑ.

    ุชุทุจูโูพุฐุฑ ููุงุณุจุช: ุณุณุชู RAMADAN_MODE ุฌูุช ุชุบุฑ ุฎูุฏฺฉุงุฑ ููู ูุนุฏูโูุง (ุณุญุฑ/ุงูุทุงุฑ ุจู ุฌุง ุตุจุญุงูู/ูุงูุงุฑ/ุดุงู).

    ููู ุฌูู ุงุฌุจุงุฑ: ุงุนุชุจุงุฑุณูุฌ ุนุถูุช ฺฉุงุฑุจุฑ ุฏุฑ ฺฉุงูุงู ุชุนูโุดุฏู ูพุด ุงุฒ ุงุฑุงุฆู ุฎุฏูุงุช.

    ุงุฑุชุจุงุท ูุณุชูู: ุงุฑุณุงู ุฏุฑุฎูุงุณุชโูุง ุจู Topic ุงุฎุชุตุงุต ุฏุฑ ฺฏุฑูู ุฏุงูุดฺฏุงู ููุฑุงู ุจุง ุฏฺฉูู ุงุฑุชุจุงุท ูุณุชูู ุจุง ุฏุงูุดุฌู (url button).

๐จโ๐ป ูฺฺฏโูุง ูพูู ูุฏุฑุช (Admin-Side)

    ุฏุงุดุจูุฑุฏ ุขูุงุฑ ูุญุธูโุง (Real-time Analytics): ุชูฺฉฺฉ ุฏูู ุขูุงุฑ ฺฉุงุฑุจุฑุงู ู ุฏุฑุฎูุงุณุชโูุง ุจู ุตูุฑุช ุฑูุฒุงููุ ููุชฺฏ ู ูุงูุงููุ ู ููุงุด ูุญุจูุจโุชุฑู ุณููโูุง ู ูุนุฏูโูุง.

    ุณุณุชู ูพุงู ููฺฏุงู ูพุดุฑูุชู (Smart Broadcast):

        ุตูโุจูุฏ (Batching) ุงุฑุณุงู ูพุงูโูุง (ูุซูุงู ฒต ูพุงู ุจุง ุชุงุฎุฑ ฑ.ฑ ุซุงูู) ุฌูุช ุฌููฺฏุฑ ุงุฒ ูุญุฏูุฏุชโูุง ุชูฺฏุฑุงู.

        ฺฉูุชุฑู ููุดููุฏ Rate Limit (ุฎุทุง 429) ู ุชูุงุด ูุฌุฏุฏ ุจุฑ ุงุณุงุณ retry_after.

        ฺฏุฒุงุฑุด ูุญุธูโุง ูพุดุฑูุช ูุฑุขูุฏ (Progress Bar)ุ ุชุฎูู ุฒูุงู ุจุงููุงูุฏูุ ู ุขูุงุฑ ูููู/ูุงูููู/ุจูุงฺฉ.

        ูพุดุชุจุงู ุงุฒ ุงุฑุณุงู ุงููุงุน ูุฏุง (ูุชูุ ุนฺฉุณุ ูุฏู ู...).

    ูุฏุฑุช ุฏูุงูฺฉ: ูุงุจูุช ุงูุฒูุฏู ุง ุญุฐู ุงุฏููโูุง ู ุณููโูุง ุบุฐุงุฎูุฑ ูุณุชููุงู ุงุฒ ุทุฑู ุฑุจุงุช.

๐ ุฑุงูููุง ุฑุงูโุงูุฏุงุฒ ู ุงุณุชูุฑุงุฑ (Deployment)

ุจุฑุง ุงุฌุฑุง ุงู ุฑุจุงุช ุจุฑ ุฑู ุงฺฉุงูุช Cloudflare ุฎูุฏุ ูุฑุงุญู ุฒุฑ ุฑุง ุจู ุฏูุช ุฏูุจุงู ฺฉูุฏ:
ฑ. ูพุดโูุงุฒูุง

    ูุตุจ ุจูุฏู Node.js.

    ูุตุจ ุจูุฏู ุงุจุฒุงุฑ ุฎุท ูุฑูุงู ฺฉููุฏููุฑ (Wrangler):

    bash
    npm install -g wrangler
    wrangler login

    ุฏุฑุงูุช ุชูฺฉู ุฑุจุงุช ุงุฒ BotFather.

ฒ. ูพฺฉุฑุจูุฏ ุฏุชุงุจุณ (Cloudflare D1)

ุงุจุชุฏุง ฺฉ ุฏุชุงุจุณ ุฌุฏุฏ ุฏุฑ ฺฉููุฏููุฑ ุงุฌุงุฏ ฺฉูุฏ:

bash
```
wrangler d1 create dining-bot-db
```
ูพุณ ุงุฒ ุงุฌุฑุง ุงู ุฏุณุชูุฑุ ุฎุฑูุฌ ุฏุงุฏู ุดุฏู (ุดุงูู database_name ู database_id) ุฑุง ุงุฏุฏุงุดุช ฺฉูุฏ.

ูุงู ุจุง ูุงู schema.sql ุฏุฑ ูุณุฑ ูพุฑูฺู ุงุฌุงุฏ ฺฉุฑุฏู ู ุณุงุฎุชุงุฑ ุฌุฏุงูู ุฑุง ุฏุฑ ุขู ูุฑุงุฑ ุฏูุฏ:

sql
```
-- schema.sql
CREATE TABLE IF NOT EXISTS admins (user_id INTEGER PRIMARY KEY, username TEXT, added_by INTEGER);
CREATE TABLE IF NOT EXISTS dinings (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT, added_by INTEGER);
CREATE TABLE IF NOT EXISTS submissions (user_id INTEGER, submission_date TEXT, count INTEGER, deleted INTEGER DEFAULT 0, PRIMARY KEY (user_id, submission_date));
CREATE TABLE IF NOT EXISTS user_states (user_id INTEGER PRIMARY KEY, state_data TEXT, updated_at TEXT);
CREATE TABLE IF NOT EXISTS request_cache (request_key TEXT PRIMARY KEY, created_at TEXT);
CREATE TABLE IF NOT EXISTS users (user_id INTEGER PRIMARY KEY);
CREATE TABLE IF NOT EXISTS user_activity (user_id INTEGER, period_type TEXT, period_value TEXT, PRIMARY KEY (user_id, period_type, period_value));
CREATE TABLE IF NOT EXISTS stats (stat_type TEXT, period_type TEXT, period_value TEXT, value INTEGER, PRIMARY KEY (stat_type, period_type, period_value));
CREATE TABLE IF NOT EXISTS popular_items (item_type TEXT, item_name TEXT, count INTEGER, PRIMARY KEY (item_type, item_name));
```
ุณูพุณ ุฌุฏุงูู ุฑุง ุฑู ุฏุชุงุจุณ ุงุนูุงู ฺฉูุฏ:

bash
```
wrangler d1 execute dining-bot-db --file=./schema.sql --remote
```
ณ. ุชูุธูุงุช ูุงู wrangler.toml

ูุงู ูพฺฉุฑุจูุฏ ฺฉููุฏููุฑ ูุฑฺฉุฑ (wrangler.toml) ุฑุง ุจู ุดฺฉู ุฒุฑ ุงุฌุงุฏ ฺฉูุฏ:

text
```
name = "dining-telegram-bot"
main = "index.js"
compatibility_date = "2024-02-22"
```

[[d1_databases]]
binding = "DB"
database_name = "dining-bot-db"
database_id = "ุดูุงุณู_ุฏุชุงุจุณ_ุดูุง"

ด. ุฐุฎุฑู ุงูู ุชูฺฉู ุชูฺฏุฑุงู (Secrets)

ุชูฺฉู ุฑุจุงุช ูุจุงุฏ ุฏุฑ ฺฉุฏ ุณูุฑุณ ูุฑุงุฑ ุจฺฏุฑุฏ. ุขู ุฑุง ุจู ุนููุงู ฺฉ ูุชุบุฑ ูุญุท ุฑูุฒูฺฏุงุฑโุดุฏู ุฏุฑ ฺฉููุฏููุฑ ุฐุฎุฑู ฺฉูุฏ:

bash
```
wrangler secret put BOT_TOKEN
```
(ูพุณ ุงุฒ ุงุฌุฑุง ุฏุณุชูุฑุ ุชูฺฉู ุฏุฑุงูุช ุดุฏู ุงุฒ BotFather ุฑุง Paste ฺฉูุฏ).
ต. ุชูุธูุงุช ูุชุบุฑูุง ุฏุฑูู ฺฉุฏ (Configuration)

ูพุด ุงุฒ ุงุณุชูุฑุงุฑุ ูุชุบุฑูุง ุณุฑุงุณุฑ ุงุจุชุฏุง ูุงู index.js ุฑุง ุจุง ุชูุฌู ุจู ูุงุฒ ุฎูุฏ ุดุฎุตโุณุงุฒ ฺฉูุฏ:

javascript
```
const RAMADAN_MODE = false; // ุชุบุฑ ุจู true ุฏุฑ ูุงู ูุจุงุฑฺฉ ุฑูุถุงู
const GROUP_ID = -100XXXXXXXXXX; // ุขุฏ ุนุฏุฏ ฺฏุฑูู ุฏุงูุดฺฏุงู
const TOPIC_ID = 12345; // ุขุฏ ุชุงูพฺฉ (Thread) ุฏุฑ ุตูุฑุช ุงุณุชูุงุฏู ุงุฒ ูุงุจูุช Topics
const REQUIRED_CHANNEL = '@your_channel_id'; // ุขุฏ ฺฉุงูุงู ุฌูุช ุฌูู ุงุฌุจุงุฑ
```
ถ. ุงุณุชูุฑุงุฑ ููุง (Deploy)

ุจุง ุงุณุชูุงุฏู ุงุฒ ุฏุณุชูุฑ ุฒุฑุ ูพุฑูฺู ุฑุง ุจุฑ ุฑู ุดุจฺฉู ฺฉููุฏููุฑ ุขูพููุฏ ฺฉูุฏ:

bash
```
wrangler deploy
```
ูพุณ ุงุฒ ูพุงุงู ุนููุงุชุ ฺฉ URL ุจู ุดูุง ุฏุงุฏู ูโุดูุฏ (ูุซูุงู https://dining-telegram-bot.your-username.workers.dev).
ท. ุงุชุตุงู Webhook ุจู ุชูฺฏุฑุงู

ุฏุฑ ููุงุชุ ุชูฺฏุฑุงู ุฑุง ูุทูุน ฺฉูุฏ ฺฉู ุขูพุฏุชโูุง ุฑุง ุจู ุขุฏุฑุณ Worker ุดูุง ุงุฑุณุงู ฺฉูุฏ. ุฏุฑ ูุฑูุฑฺฏุฑ ุฎูุฏ ููฺฉ ุฒุฑ ุฑุง ุจุงุฒ ฺฉูุฏ (ููุงุฏุฑ ุฑุง ุฌุงฺฏุฒู ฺฉูุฏ):

text
```
https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook?url=<YOUR_WORKER_URL>
```
ุงฺฏุฑ ุฎุฑูุฌ {"ok":true,"result":true,"description":"Webhook was set"} ุฑุง ุฏุฑุงูุช ฺฉุฑุฏุฏุ ุฑุจุงุช ุดูุง ุจุง ููููุช ุฑุงูโุงูุฏุงุฒ ุดุฏู ู ุขูุงุฏู ฺฉุงุฑ ุงุณุช! ๐
๐ก ูฺฉุงุช ุงููุช ู ูฺฏูุฏุงุฑ

    ุฌููฺฏุฑ ุงุฒ ุชุงูโุงูุช: ุจู ุฏูู ูุญุฏูุฏุชโูุง ูพุฑุฏุงุฒุด ูุณุฎู ุฑุงฺฏุงู Cloudflare Workersุ ุฏุฑ ุชูุงุจุน ุณูฺฏู (ูุซู ูพุงู ููฺฏุงู) ุญุชูุงู ุงุฒ ุณุงุฎุชุงุฑ ุงุฑุงุฆู ุดุฏู ุนู ctx.waitUntil() ุงุณุชูุงุฏู ฺฉูุฏ ุชุง ูพุฑูุณู ุฏุฑ ุจฺฉโฺฏุฑุงูุฏ ุงุฌุฑุง ุดุฏู ู ุชูฺฏุฑุงู ุฎุทุง Webhook Timeout ูฺฏุฑุฏ.

    ูพุงฺฉุณุงุฒ ุฏุชุงุจุณ: ุณุณุชู ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุฏุงุฏูโูุง request_cache (ฺฉุด ุฌููฺฏุฑ ุงุฒ ุงุณูพู) ฺฉู ุจุดุชุฑ ุงุฒ ฑ ุณุงุนุช ุงุฒ ุนูุฑุดุงู ฺฏุฐุดุชู ุจุงุดุฏ ุฑุง ูพุงฺฉ ูโฺฉูุฏ.

ุชูุณุนู ุฏุงุฏู ุดุฏู ุจุฑุง ุจูุจูุฏ ุชุฌุฑุจู ุฏุงูุดุฌู. ๐
